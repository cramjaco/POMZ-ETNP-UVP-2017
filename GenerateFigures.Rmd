---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(cowplot)
theme_set(theme_cowplot())
```


# Particles Only

# Read In Data

```{r}
bes<- read_csv("dataOut/binned_EachSize.csv")
bds <- read_csv("dataOut/binned_DepthSummary.csv")
ues <- read_csv("dataOut/unbinned_EachSize.csv")
uds <- read_csv("dataOut/unbinned_DepthSummary.csv")
```


# Summary Statistics
```{r}
PlotNParticles <- uds %>% 
  ggplot(aes(x = tot_nparticles, y = depth, col = profile)) +
 facet_wrap(~project) +
 geom_point(alpha = 0.3, shape = 1) +
scale_y_reverse() + scale_x_log10()

PlotNParticles
```



```{r}
PlotPSD <- uds %>% 
  filter(project == "ETNP") %>%
  ggplot(aes(x = psd, y = depth, col = profile)) +
 geom_point(alpha = 0.3, shape = 1) +
  geom_path(aes(x = psd_gam)) + 
  geom_ribbon(aes(x = psd_gam, xmin = psd_gam - 2 * psd_seg, xmax = psd_gam + 2 * psd_seg), alpha = 0.1) +
scale_y_reverse()

PlotPSD
```

I wonder if I can show that the profiles aren't statistically significanlty different. Or that they are for that matter...
I think in that case, I run a gam with and without a parameter for profile...
And then quantify the effect size of that parameter

Or follow this Gavin Simpson Post
https://fromthebottomoftheheap.net/2017/10/10/difference-splines-i/

or 
anova.gam {mgcv}

Calculate gams for each profile, and then run anova.gam to see if they are different...

```{r}
PlotNParticles <- uds %>% 
  filter(profile %in% c("stn_043", "p16n_100")) %>%
  ggplot(aes(x = tot_nparticles, y = depth, col = project)) +
 geom_point(alpha = 0.7, shape = 1) +
  #geom_path(aes(x = tot_nparticles)) +
  #geom_ribbon(aes(x = psd_gam, xmin = psd_gam - 2 * psd_seg, xmax = psd_gam + 2 * psd_seg), alpha = 0.1) +
scale_y_reverse(limits = c(2500, 0)) + scale_x_log10()

PlotNParticles
```

```{r}
PlotPSD <- uds %>% 
  filter(profile %in% c("stn_043", "p16n_100")) %>%
  ggplot(aes(x = psd, y = depth, col = project)) +
 geom_point(alpha = 0.7, shape = 1) +
  geom_path(aes(x = psd_gam)) +
  geom_ribbon(aes(x = psd_gam, xmin = psd_gam - 2 * psd_seg, xmax = psd_gam + 2 * psd_seg), alpha = 0.1) +
scale_y_reverse(limits = c(2500, 0)) 

PlotPSD
```

I may just cow these togther.

```{r}
plot_grid(PlotNParticles, PlotPSD)
```

```{r}
mainParticleComponents <- bds %>%
  filter(profile %in% c("stn_043", "p16n_100")) %>%
  select(project, profile, depth,
         tot_nparticles, small_nparticles, big_nparticles,
         tot_psd = psd, small_psd, big_psd,
         tot_flux_fit, small_flux_fit, big_flux_fit) %>%
  pivot_longer(cols = -c("project", "profile", "depth")) %>%
  separate(name, c("size", "meas")) 

PlotFlx <- mainParticleComponents %>% 
  filter(meas != "psd") %>%
  ggplot(aes(y = depth, x = value, col = project)) + facet_grid(size ~ meas, scales = "free_x") + geom_point() + scale_y_reverse(limits = c(2500, 0)) + scale_x_log10() + theme(axis.title.x = element_blank(), legend.position = "none", strip.background.y = element_blank(), strip.text.y = element_blank(), plot.margin = unit(c(7,0,7,7), "pt"))

PlotPSD <- mainParticleComponents %>% 
  filter(meas == "psd") %>%
  ggplot(aes(y = depth, x = value, col = project)) + facet_grid(size~meas, scales = "free_x") + geom_point() + scale_y_reverse(limits = c(2500, 0)) +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.line.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank(), plot.margin = unit(c(7,7,7,0), "pt"))

plot_grid(PlotFlx, PlotPSD, rel_widths = c(3, 2))
```

```{r}
eg_dataline <- bds %>% 
  filter(profile == "stn_043", depth == 162.5)
eg_slope =  eg_dataline %>% pull(psd)
eg_icp = eg_dataline %>% pull(icp)
eg_vol = eg_dataline %>% pull(vol)


eg_lb = unique(bes$lb)
eg_binsize = unique(bes$binsize)
eg_nnp = exp(eg_icp + log(eg_lb) * eg_slope)

eg_np = eg_nnp * eg_binsize
eg_tp = eg_np * eg_vol
eg_df <- tibble(lb = eg_lb, n_nparticles = eg_nnp)


bes %>% filter(profile == "stn_043", depth == 162.5) %>%
  ggplot(aes(x = lb, y = n_nparticles)) + geom_point() + scale_x_log10() + scale_y_log10() + 
  geom_path(data = eg_df)
```

